# HomeAlerts
Managing sensors to create alarms

## Idea
Manage several sensors, monitors (that read sensor events, and create new events) and actors (read events and send alerts, change system values etc)

## Architecture
* use [Apache Kafka](https://kafka.apache.org/) as Event Streaming Platform that receives all events generated by the distributed system (Sensors, Monitors and Actors are running on different machines)
  * Sensors (e.g [Temperature Sensors](https://github.com/brakid/Sensor), [Webcameras](https://github.com/brakid/MLNotebooks/blob/master/webcam.py)) write messages into topics
  * Monitors read events from the topics, compare values with each other (e.g temperature changes over time, detecting motion in webcam images), create new events in different topics (e.g a temperature drop alert)
  * Actors read events and act upon them (e.g turn on the heating, send an alert)
* the central place for events allows an easy creation of new events, receiver can subscribe to new events. Compared to messaging queues, Kafka delivers all events to all subscribers - replicating these in Message Queues is harder (e.g having to maintain multiple queues, or explicit [fan-out](https://hevodata.com/learn/rabbitmq-exchange-type/#fanout) steps (as in [RabbitMQ](https://www.rabbitmq.com/)) - see: [Fan Controller Project](https://github.com/brakid/FanController)
* decoupling Sensors and Monitors: Sensors must not be aware of any Monitors observing them, Monitors can observe multiple Sensors (via subscribing to multiple topics), they keep their own logic for keeping track of values over time

## Questions:
* Kafka limitations (How large can messages be? Can one send whole images or is it better to create a central storage and send file references only?)
  * A: up to 1MB, for the image case: reduce the image size (640 x 480), encode as JPEG
* starting monitors up: how to ensure they receive recent data from the topics - especially important for for infrequently generated data, e.g. from other monitors)
  * A: change consumer setting to receive all messages in the topic (```auto_offset_reset='earliest'```, see: [KafkaConsumer](https://kafka-python.readthedocs.io/en/master/apidoc/KafkaConsumer.html)), by default the Kafka Docker keeps data for the Confluent Kafka Docker image is set to 1 day ([Confluent](https://docs.confluent.io/platform/current/installation/configuration/topic-configs.html#delete-retention-ms), [Retention](https://www.baeldung.com/kafka-message-retention))

## Implemented Sensors, Monitors and Actors:
### Sensors
* Temperature Sensor: read the current temperature ([Raspberry Pi & DB18B20 Temperature Sensor](https://www.circuitbasics.com/raspberry-pi-ds18b20-temperature-sensor-tutorial/)) -> send to a ```temperature```topic
* Webcam Sensor: read an image from a webcam every ```X```seconds, convert to a base64 encoded string -> send to a ```webcam```topic
### Monitors
* Temperature Monitor: Temperature < ```THRESHOLD```or Temperature > ```THRESHOLD```-> send an alert to an ```alert``` topic
* Motion Detector: compare 2 webcam images, if the difference exceed a threshold -> send an alert
```python
def detect_motion(img1: np.ndarray, img2: np.ndarray) -> bool:
    diff = cv2.absdiff(img1, img2)
    eroded_diff = cv2.erode(diff, KERNEL, cv2.BORDER_REFLECT)
    motion = np.mean(eroded_diff) > MOTION_THRESHOLD

    return motion
```
### Actors
* [Telegram Bot Actor](https://core.telegram.org/bots/api): react on all alerts to [send a message](https://python-telegram-bot.org/) to the owner of the sensors

## Monitor Ideas:
* Geofencing & Security Webcam -> leave the house -> enable motion detection, disable when coming back
  * https://ifttt.com/location
* object tracking: identfy objects in the webcam image and track them over time (detect objects ([Yolo](https://arxiv.org/abs/1506.02640)), identify them across frames [SIFT](https://en.wikipedia.org/wiki/Scale-invariant_feature_transform))
* object recognition: run [face recognition](https://machinelearningmastery.com/how-to-develop-a-face-recognition-system-using-facenet-in-keras-and-an-svm-classifier/) to check for known faces

## Links:
* Kafka Docker setup: https://www.baeldung.com/ops/kafka-docker-setup - needing to update the KAFKA_ADVERTISED_LISTENERS: instead of localhost use the name/IP of the host it is running on (see: https://github.com/wurstmeister/kafka-docker/blob/master/README.md)
* Kafka Python client: https://kafka-python.readthedocs.io/en/master/index.html
* Kafka Concepts: https://www.youtube.com/watch?v=Ch5VhJzaoaI
* NodeJS Kafka: https://kafka.js.org
* Typescript & Babel: https://babeljs.io/docs/babel-preset-typescript#installation
* SocketIO: https://socket.io/
