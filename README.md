# HomeAlerts
Managing sensors to create alarms

## Idea
Manage several sensors, monitors (that read sensor events, and create new events) and actors (read events and send alerts, change system values etc)

## Architecture
* use [Apache Kafka](https://kafka.apache.org/) as Event Streaming Platform that receives all events generated by the distributed system (Sensors, Monitors and Actors are running on different machines)
  * Sensors (e.g [Temperature Sensors](https://github.com/brakid/Sensor), [Webcameras](https://github.com/brakid/MLNotebooks/blob/master/webcam.py)) write messages into topics
  * Monitors read events from the topics, compare values with each other (e.g temperature changes over time, detecting motion in webcam images), create new events in different topics (e.g a temperature drop alert)
  * Actors read events and act upon them (e.g turn on the heating, send an alert)
* the central place for events allows an easy creation of new events, receiver can subscribe to new events. Compared to messaging queues, Kafka delivers all events to all subscribers - replicating these in Message Queues is harder (e.g having to maintain multiple queues, or explicit [fan-out](https://hevodata.com/learn/rabbitmq-exchange-type/#fanout) steps (as in [RabbitMQ](https://www.rabbitmq.com/)) - see: [Fan Controller Project](https://github.com/brakid/FanController)
* decoupling Sensors and Monitors: Sensors must not be aware of any Monitors observing them, Monitors can observe multiple Sensors (via subscribing to multiple topics), they keep their own logic for keeping track of values over time

## Questions:
* Kafka limitations (How large can messages be? Can one send whole images or is it better to create a central storage and send file references only?)
* starting monitors up: how to ensure they receive recent data from the topics - especially important for for infrequently generated data, e.g. from other monitors)

## Monitor Ideas:
* Geofencing & Security Webcam -> leave the house -> enable motion detection, disable when coming back
  * https://ifttt.com/location
  * Webcam with motion detector (difference between 2 consequtive images)
```python
def detect_motion(img1: np.ndarray, img2: np.ndarray) -> bool:
    diff = cv2.absdiff(img1, img2)
    eroded_diff = cv2.erode(diff, KERNEL, cv2.BORDER_REFLECT)
    motion = np.mean(eroded_diff) > MOTION_THRESHOLD

    return motion
```

## Links:
* Kafka Docker setup: https://www.baeldung.com/ops/kafka-docker-setup - needing to update the KAFKA_ADVERTISED_LISTENERS: instead of localhost use the name/IP of the host it is running on (see: https://github.com/wurstmeister/kafka-docker/blob/master/README.md)
* Kafka Python client: https://kafka-python.readthedocs.io/en/master/index.html
